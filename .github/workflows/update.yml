name: update
on:
  schedule:
    - cron: "0 2 * * 6"
  workflow_dispatch:
jobs:
  update:
    name: Update flake
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: DeterminateSystems/flakehub-cache-action@v3
      - uses: DeterminateSystems/flake-checker-action@v12
      - name: Update git config author
        run: |
          git config --global user.name "Casey Link"
          git config --global user.email "14830+Ramblurr@users.noreply.github.com"
      #- run: nix flake check
      - name: Update flake inputs
        run: nix flake update --commit-lock-file
      - name: Update packages
        run: nix run --inputs-from . nixpkgs#nushell -L -- pkgs/update.nu
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet origin/main HEAD; then
            echo "No commits were made, nothing to update"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi
      - name: Generate PR Body
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are running in CI. Look at .github/workflows/update.yml to see what was done before you were invoked.
            There may or may not be some commits that were just comitted. Use the git cli tool to look at those commits.
            What was changed? What packages were updated, if any? From what version to what version? Was the nix lock file updated?
            Create the file ./pr-body, the contents of this file will become the body of the PR for these commits.
            IMPORTANT:
              - DO NOT add introductions or explanations.
              - DO NOT say "Analyzing commits..." or similar phrases.
              - DO NOT edit the commits or any other files
              - Start directly with the tag name.
              - Then write a list of bullet points about the changes.
              - Write in simple English.
            If there are no commits (maybe there were no updates to do, then simply stop, do not create the file)
          claude_args: |
            --max-turns 10
      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH="auto-update/$(date +%Y-%m-%d)"
          git checkout -b "$BRANCH"

          # Check if branch exists on remote
          if git ls-remote --exit-code --heads origin "$BRANCH" > /dev/null 2>&1; then
            echo "Branch $BRANCH already exists on remote"

            # Check if there's an open PR for this branch
            PR_STATE=$(gh pr view "$BRANCH" --json state --jq '.state' 2>/dev/null || echo "NONE")

            if [ "$PR_STATE" = "OPEN" ]; then
              echo "Open PR exists, force pushing updates to existing branch"
              git push --force-with-lease origin "$BRANCH"
              gh pr comment "$BRANCH" --body-file ./pr-body
              echo "PR updated with new changes and comment added"
            else
              echo "No open PR (state: $PR_STATE), force pushing and creating new PR"
              git push --force origin "$BRANCH"
              gh pr create \
                --title "chore: Weekly flake and package updates" \
                --body-file ./pr-body \
                --base main \
                --head "$BRANCH"
            fi
          else
            echo "Branch does not exist, creating new branch and PR"
            git push -u origin "$BRANCH"
            gh pr create \
              --title "chore: Weekly flake and package updates" \
              --body-file ./pr-body \
              --base main \
              --head "$BRANCH"
          fi
